---
title: "ISLR Survival Analysis"
author: "Alec Becker"
date: "11/24/2021"
output: html_document
---

### Set up and data import

First, we load the libraries and data that will be called in this script

```{r settings, include = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

```{r libs}
# Libraries
library(ISLR2)
library(tidyverse)
library(GGally)
library(survival)
library(survminer)

# Call and rename dataset from ISLR2 package
data(BrainCancer)
df <- BrainCancer
```


### Exploratory Data Analysis

Then, we explore the data's structure using the `str` function and summary statistics with the `summary` function.

```{r eda1}
str(df)
summary(df)
```

For another look, we examine the first five observations of the data using the `head` function.

```{r eda2}
head(df)
```

To explore how survival probability changes as a function of observation time in the full sample, we fit a Kaplan-Meier curve. This method accounts for the censoring present in our data (indicated by `status` = 0).

```{r km1}
df$status <- as.integer(df$status)
surv_fit1 <- survival::survfit(survival::Surv(time, status) ~ 1, data = df)
survminer::ggsurvplot(surv_fit1, data = df, surv.median.line = "h", risk.table = TRUE, ggtheme = theme_bw())

```

The above plot shows the full sample's median survival, or the timepoint at which survival probability reaches 50%, at a bit under 50 years of age. From there, there are only marginal decreases in survival probability with increasing age.

While interesting, exploring how the explanatory variables in our dataset may differentially impact survival probability would be more informative. To do that, we fit a Kaplan-Meier curve for each of the categorical variables in our dataset (i.e., `sex`, `diagnosis`, `loc`, and `stereo`.) We will fit plots for the continuous variables in a later step. 


```{r km2, fig.width = 12, fig.height = 12}

cat_vars <- c("sex", "diagnosis", "loc", "stereo")

surv_plots <- lapply(cat_vars, function(x) {
  formula <- as.formula(paste0("survival::Surv(time, status) ~ ", x))
  surv_fit <- survminer::surv_fit(formula, data = df)
  survplot <- ggsurvplot(surv_fit, data = df, pval = TRUE, surv.median.line = "h", risk.table = TRUE, ggtheme = theme_bw()) +
               guides(color = guide_legend(nrow = 2))
})

survminer::arrange_ggsurvplots(surv_plots, ncol = 2, nrow = 2)

```


From the plots above, we see that `diagnosis` (type of brain cancer diagnoses) and `stereo` (location of brain cancer) had the most substantial impact. Among the types of diagnoses in this dataset, HG glioma was the most lethal. Of the two stereotactic radiation therapies, receiving SRT (i.e., stereotactic radiotherapy) was related to shorter survival time.

Based on visual inspection, `sex` and `loc` (location of brain cancer) may impact risk of death. However, the p-values for both were greater than 0.05. This means we cannot reject the null hypothesis and we we cannot say with at least 95% confidence that either variable likely has a true relationship with survival time. These failures to reject the null hypothesis could be a function of lack of statistical power driven by small sample size. It is possible that, given a larger dataset drawn from the same population and context, we would have observed statistically significant relationships for these variables.

We now turn to the two continuous variables in the data -- `ki` (Karnofsky index) and `gtv` (Gross Tumor Volume, in cubic centimeters), fitting a scatter plots over observation time among those that died. Including only those that died will allow us to remove the effect of censoring.

```{r cont_plots, fig.width = 10, fig.height = 5}
ki_plot <- ggplot(df[df$status == 1,], aes(x = time, y = ki)) +
  geom_point() +
  theme_bw() +
  labs(
    title = "Karnofsky index (ki) vs.\nObservation Time (time)"
  )

gtv_plot <- ggplot(df[df$status == 1,], aes(x = time, y = gtv)) +
  geom_point() +
  theme_bw() +
  labs(
    title = "Gross Tumor Volume in cm^3 (gtv) vs.\nObservation Time (time)"
  )

gridExtra::grid.arrange(grobs = list(ki_plot, gtv_plot), nrow = 1, ncol = 2)

```


We will now build a Cox regression to model survival time as a function of our explanatory variables. This will allow us to obtain hazard ratios that will shed light on the strength and direction of impact that each variable has on survival time. If the model is accurate and well-specified, we may be able to use it as a tool to generate survival time predictions.

### Modelling

```{r model}
model1 <- survival::coxph(survival::Surv(time, status) ~ ., data = df)
summary1 <- summary(model1)
table1 <- broom::tidy(model1, conf.int = TRUE, exponentiate = TRUE)[c("term", "estimate", "conf.low", "conf.high")] %>% 
            mutate_if(is.numeric, round, 2)

table1

```




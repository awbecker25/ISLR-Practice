---
title: "Brain Cancer Survival Analysis"
author: "Alec Becker"
date: "11/24/2021"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: flatly
---

### Introduction

This analysis uses the `BrainCancer` dataset from the `ISLR2` R package to perform survival analysis. The outcome of interest is survival time after receiving a brain cancer diagnosis.

*Note: The ISLR2 package is available on CRAN: https://CRAN.R-project.org/package=ISLR2*

### Set up and data import

First, we load the libraries and data that will be used in this script. We also set aside a roughly 10% random sample of the dataset to use for testing the predictive accuracy of the [Cox proportional-hazards regression model](https://sphweb.bumc.bu.edu/otlt/MPH-Modules/BS/BS704_Survival/BS704_Survival6.html) we will build toward the end of the analysis.

```{r settings, include = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

```{r libs}
# Load libraries
library(ISLR2)
library(tidyverse)
library(survival)
library(survminer)

# Call and rename dataset from ISLR2 package
data(BrainCancer)
df <- BrainCancer

# Select an approximate 10% sample for the hold-out testing set
set.seed(42)
test_rows <- sample(nrow(df), round((nrow(df) * 10) / 100))

train <- df[-test_rows,]
test <- df[test_rows,]
```


### Exploratory data analysis

Then, we explore the training data's structure using the `str` function and summary statistics with the `summary` function. We see it contains 8 variables and 79 observations.

```{r eda1}
# Dataset structure
str(train)

# Variable summary statistics
summary(train)
```

The summary statistics show us that:

- The modal `sex` (binary biological sex of the observation) was female (42/79, or 53%).
- The modal `diagnosis` (type of brain cancer diagnosis received) was [Meningioma](https://braintumor.org/brain-tumor-information/brain-tumor-glossary/?gclid=Cj0KCQiAhf2MBhDNARIsAKXU5GQaT6n9tusZiDQszt64wEeQ2oPlOVWVK6-QLsSn9-8aKaR8jCB3WOUaAhHlEALw_wcB) (38/79, or 49%).
- The modal `loc` (location of the tumor within the brain) was [supratentorial](https://www.ncbi.nlm.nih.gov/books/NBK65903/figure/CDR0000574573__205/) (62/79, or 78%).
- The mean and median of `ki` ([Karnofsky index](https://www.sciencedirect.com/topics/medicine-and-dentistry/karnofsky-performance-status)) was about 81 and 80, respectively. The closeness of the mean and median suggests the distribution is not heavily skewed.
- The mean and median of `gtv` (gross tumor volume, in cubic centimeters) was about 9 and 7, respectively. The mean being higher than the median suggests the distribution is somewhat right skewed.
- The modal `stereo` (type of [stereotactic radiation](http://www.theangelesclinic.org/Home/PatientEducationLibrary/tabid/19283/ctl/View/mid/35200/Default.aspx?ContentPubID=426#:~:text=SRS%20involves%20a%20single%20radiation,performed%20on%20an%20outpatient%20basis.) received) was SRT (57/79, or 72%).
- As shown by the mean of `status` (binary indicator for patient death by end of study period), about 39% of the training observations died by the end of the study period. The remaining 61% were censored, meaning they either dropped out before the study period ended or were alive at the end of the study period.
- The mean and median of `time` (survival/observation time) was about 27 and 24 months, respectively. There may be slight right skew in this variable's distribution.


To get a glimpse of the raw data, we examine the first six observations of the training data using the `head` function.

```{r eda2}
# Show first six rows of data
head(train)
```

To explore how survival probability changes as a function of observation time in the training data, we fit a Kaplan-Meier curve. This method accounts for the censoring present in the data (indicated by `status` = 0). An observation is said to be censored if the participant either dropped out before the study period ended or did not have the event -- in this case, death -- by the time the study ended. Censored data require special handling because their true status is not known. 

```{r km1}
# Fit and plot a Kaplan-Meier curve for the full training sample
surv_fit1 <- survival::survfit(survival::Surv(time, status) ~ 1, data = train)
survminer::ggsurvplot(surv_fit1, data = train, surv.median.line = "h", risk.table = TRUE, ggtheme = theme_bw())
```

The above plot shows the training sample's median survival, or the time point at which survival probability reached 50%, was a bit under 50 months post-diagnosis. From there, survival probability marginally decreased and then plateaued at longer durations of time.

While informative, we are really interested in how the explanatory variables in the dataset may have impacted survival probability. To do that, we fit a Kaplan-Meier curve for each of the categorical predictors (i.e., `sex`, `diagnosis`, `loc`, and `stereo`.) We will fit plots for the continuous variables in a later step. 


```{r km2, fig.width = 12, fig.height = 12}
# Define a vector of the factor variables in the dataset
cat_vars <- c("sex", "diagnosis", "loc", "stereo")

# Create a list of Kaplan-Meier plots for each factor variable
surv_plots <- lapply(cat_vars, function(x) {
  formula <- as.formula(paste0("survival::Surv(time, status) ~ ", x))
  surv_fit <- survminer::surv_fit(formula, data = train)
  survplot <- ggsurvplot(surv_fit, data = train, pval = TRUE, surv.median.line = "h", risk.table = TRUE, ggtheme = theme_bw()) +
               guides(color = guide_legend(nrow = 2))
})

# Arrange the Kaplan-Meier plots on a 2 x 2 grid
survminer::arrange_ggsurvplots(surv_plots, ncol = 2, nrow = 2)
```


From the plots above, we see that `diagnosis` (type of brain cancer diagnosis) and `stereo` (type of stereotactic radiation received) had the most statistically significant relationships with survival time. Among the types of diagnoses in this dataset, HG glioma was the most lethal. Of the two stereotactic radiation types, receiving SRT (i.e., stereotactic radiotherapy) was related to shorter survival time.

Based on visual inspection, `sex` and `loc` (location of brain cancer) may have been related to survival time. However, the p-values for both were greater than 0.05. This means we cannot reject the null hypothesis and we we cannot say with at least 95% confidence that either variable likely has a true relationship with survival time. These failures to reject the null hypothesis could be a function of lack of statistical power driven by small sample size. It is possible that, given a larger dataset drawn from the same population and context, we would have observed statistically significant relationships for these variables.

We now turn to the two continuous variables in the data -- `ki` (Karnofsky index) and `gtv` (gross tumor volume, in cubic centimeters). For those that died, we create scatter plots with observation time on the y axes. Including only those that died will allow us to remove censoring as an issue.

```{r cont_plots, fig.width = 8, fig.height = 4}
# Scatter plot of survival time over ki values
ki_plot <- ggplot(train[train$status == 1,], aes(x = ki, y = time)) +
  geom_point() +
  theme_bw() +
  labs(
    title = "Karnofsky index (ki) vs.\nSurvival Time (time)"
  ) +
  geom_smooth(method = 'lm', se = FALSE)


# Scatter plot of survival time over gtv values
gtv_plot <- ggplot(train[train$status == 1,], aes(x = gtv, y = time)) +
  geom_point() +
  theme_bw() +
  labs(
    title = "Gross Tumor Volume in cm^3 (gtv) vs.\nSurvival Time (time)"
  ) +
  geom_smooth(method = 'lm', se = FALSE)

gridExtra::grid.arrange(grobs = list(ki_plot, gtv_plot), nrow = 1, ncol = 2)
```

The above charts suggest that survival time tended to be somewhat *higher* for higher Karnofsky index values, and tended to be somewhat *lower* for higher gross tumor volumes.

### Model building

We will now build a Cox proportional-hazards regression to model death risk over time as a function of our explanatory variables. This will allow us to obtain hazard ratios that will suggest the strength and direction of association that each variable had with time to death. In a later step, we will assess the accuracy of the model on the test set.


```{r model}
# Fit Cox model
model <- survival::coxph(survival::Surv(time, status) ~ ., data = train)

# Examine model summary
summary1 <- summary(model)

# Produce a tidy table of the model results using the broom package
table <- broom::tidy(model, conf.int = TRUE, exponentiate = TRUE)[c("term", "estimate", "conf.low", "conf.high", "p.value")] %>% 
            mutate_if(is.numeric, function(x) format(round(x, 2), nsmall = 2))

# Beautify the table of model results
knitr::kable(table, col.names = c("Indicator", "HR", "HR (Low)", "HR (High)", "p-value")) %>% 
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>%
  kableExtra::row_spec(row = c(2, 3, 6, 7), bold = TRUE)
```

The model results show that, all other variables in the model held equal:

- Having an **LG glioma** diagnosis was associated with about **5 times greater instantaneous risk of death** in comparison with a diagnosis a Meningioma.
- Having an **HG glioma** diagnosis was associated with about **16 times greater instantaneous risk of death** in comparison with a diagnosis a Meningioma. 
- Each one-unit increase in **Karnofsky index values** was associated with a **5% reduction in the instantaneous risk of death**.
- Each one-unit increase in **gross tumor volume** was associated with a **6% increase in the instantaneous risk of death**.

*Note: "instantaneous risk of death" refers to the risk of death at any given instant (i.e., time point). We can also refer to this as the hazard of death.*

### Model evaluation

Next, we will assess the predictive accuracy of our model via [Harell's concordance index](https://cran.r-project.org/web/packages/survival/vignettes/concordance.pdf). 

```{r validate}
# Calculate concordance of the Cox model (fitted with the training data)
survival::concordance(model)

# Calculate concordance of the Cox model using the test data to assess model generalizability
survival::concordance(model, newdata = test)
```

While the model performs well on the training data used to build the model ([concordance](https://www.sciencedirect.com/science/article/pii/S1532046420301246) of about 83%), the more important measure in terms of generalizability is its performance on the testing data. Fitting and evaluating the model on the testing data allows us to estimate how well the model fits new, unseen data.

The test-set results are not impressive. The concordance value can be interpreted as such: the Cox model can predict with about 47% accuracy which participant will die first, given two random observations from the test set. This means our model, while useful for inference, would be inappropriate for predictions with new, unseen data. The relatively high concordance on the training data in comparison with the much lower concordance on the testing data suggests that the model was overfit to the training data. To improve predictive accuracy on unseen data, regularization or other time-to-event model types could be attempted. As well, the model would likely be improved with more training observations.

### Conclusion

This analysis shed light on factors that may be related to risk of death over time after a brain cancer diagnosis. Specifically, diagnoses of LG and HG glioma, as well as having tumors with larger gross volume, were related to increased risk of death over time. In contrast, higher values on the Karnofsky index were related to lower risk of death over time.

The practical implications of these findings are that those with high- and low-grade (HG and LG, respectively) gliomas may be likely to die sooner than those with other types of brain tumors (the comparison for both was with Meningioma in this case). As well, those with larger gross tumor volumes may be likely to die sooner in comparison with those with lower gross tumor volumes. Higher scores of the Karnofsky index suggest a patient may live longer in comparison with those that have lower scores on the Karnofsky index.

It is important to note that this analysis cannot say anything with certainty about causal effects. The observed associations *could* be indicative of causal effects, but additional studies with experimental or quasi-experimental designs would be needed to establish causal relationships with greater certainty. We should be especially careful in interpreting the associations given that the model did not appear to generalize well.

Future analyses should seek to improve predictive accuracy on unseen data through the use of larger training datasets, and potentially through the application of regularization or alternative model types for time-to-event analysis. 
